---
title: "Data Visualization"
author: "Rachel Fellman"
date: "2024-07-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
library(modeldata)
library(corrplot)
```

Clean data
```{r}
data("hotel_rates")

#change certain rows to factors
myhotel<- hotel_rates %>% 
  mutate(is_repeated_guest = as.factor(is_repeated_guest), previous_cancellations,
         near_christmas = as.factor(near_christmas),
         near_new_years = as.factor(near_new_years)) %>% 
  #take out historical_adr variable since it is not part of the original data
  select(-"historical_adr")

```

# Data visualization


ggplot(myhotel) aes(x = lead_time, y = avg_price_per_room)) + 
  geom_point(aes(color = as.factor(is_repeated_guest)))+
  scale_fill_discrete(name = "Is Repeated Guest?", labels = c("No","Yes"))

# plot 1

Scatter plot of `avg_price_per_room` vs `lead_time` (Number of days that elapsed between the entering date of the booking into the PMS and the arrival date) colored by `customer_type`.
```{r}
#make base plot
g<- ggplot(myhotel, aes(x = lead_time, y = avg_price_per_room))
#add layers
g+ geom_point(aes(color = customer_type))+
  labs(x = "lead time (days)", y = "Average Room Price (euros)")
  

```

This is a scatter plot of average room rate in euros compared to the number of days between entering the date of booking into the system and the guest's arrival date. The points are colored by customer type. It appears that the majority of bookings are transient meaning they are not associated with a group or contract. From this plot we can see that there is a slightly negative relationship between lead time and room rate.


## plot 2
bar graph of `room_type` colored by `market_segment`
```{r}
#define base plot
g<- ggplot(myhotel, aes(x = reserved_room_type))
 g+ geom_bar(aes(fill= market_segment))+
  labs(x = "Room type")
```
There appears to be a much higher count of room type a than any of the other room types. Due to the necessity of anonymity, we do not have access to what room type a is. From this graph, it also seems that the majority of all room types are from online travel agents.


## plot 3


Boxplot of `stays_in_week_nights` by `meal`

```{r}
g <- ggplot(myhotel, aes(x = meal, y = stays_in_week_nights))
g + geom_boxplot(fill = "blue")
```

From these boxplots we can see there is little difference in the median length of stay for weeknight guests among the different meal packages. The distributions among the boxplots look similar. However, there are clearly a few outliers for the bed_and_breakfast and the bed_and_breakfast_and_one_other_meal categories, so those two distributions may be slightly right skewed.




# correlation plots for numeric variables

```{r}
#filter data to include only numeric variables
myhotel.num <- myhotel %>% 
  select(avg_price_per_room,lead_time,stays_in_weekend_nights,stays_in_week_nights,adults,children,babies,previous_cancellations,previous_bookings_not_canceled,booking_changes,days_in_waiting_list,required_car_parking_spaces,total_of_special_requests,arrival_date_num)
```


```{r}
#create correlation matrix
cor.mat <- cor(myhotel.num)
```

```{r}
#plot correlation matrix
ggcorrplot::ggcorrplot(cor.mat,
           type = "lower", #looks at just half of the matrix
           method = "circle")  #change to circle
```
From this correlation plot, we can see that there is a surprisingly high correlation between stays in weeknights and stays in weekend nights. All other variables do not appear to be highly correlated.



# check linear model assumptions

## make residual plot
```{r}
# make model with all variables
model1 <- lm(avg_price_per_room~., data = myhotel)
```

```{r}
#add predictions and residuals to our dataframe to make residual plot
hotel.pred <- mutate(myhotel, pred = fitted(model1), resid = residuals(model1))
```

```{r}
#make residual plot
ggplot(hotel.pred, aes(x=pred, y = resid))+geom_point()+geom_hline(yintercept = 0, color = "red")
```


This does not fit the necessary assumptions for linear modeling. There is a clear pattern to the data and the points do not appear to be randomly scattered.
We will try transforming the data  with a log transformation to better meet the assumptions.

## transform data and make residual plot again
```{r}
#do log transformation on avg_price_per_room
hotel2 <- mutate(myhotel, avg_price_per_room = log(avg_price_per_room))
```

```{r}
#fit model again with log transformed data
model2<- lm(avg_price_per_room~., data = hotel2)
```

```{r}
#add predictions and residuals to our dataframe to make residual plot
hotel2.pred <- mutate(hotel2, pred = fitted(model2), resid = residuals(model2))
```

```{r}
#make residual plot
ggplot(hotel2.pred, aes(x=pred, y = resid))+geom_point()+geom_hline(yintercept = 0, color = "red")
```

After the log transformation, tht residuals are spread more evenly around the red line and there is no longer an obvious pattern. Therefore, our data meets the linearity assumption, the independence assumption and the equal variance assumption.


## make qq plot

```{r}
ggplot(hotel2.pred, aes(sample= resid))+stat_qq() +stat_qq_line()
```
Since the points in the qq plot follow the diagonal line, we have met the normal population assumption.


# remove data that is not stat sig (variable selection)
```{r}
summary(model2)
```


```{r}
hotel3 <- hotel2 %>% 
  select(-babies, -stays_in_week_nights, -stays_in_weekend_nights, -country)
```




```{r}
model4 <- lm(avg_price_per_room~., data = hotel3)
```


```{r}
summary(model4)
```







#fit models

```{r}
#make train and test set

set.seed(123)  # For reproducibility
trainIndex <- createDataPartition(hotel2$avg_price_per_room, p = .8, 
                                  list = FALSE, 
                                  times = 1)
trainData <- hotel2[trainIndex, ]
testData <- hotel2[-trainIndex, ]
```




```{r}
# Define the grid of alpha and lambda values
grid <- expand.grid(alpha = 1,  # Lasso regression
                    lambda = seq(-0.0001, 1, length.out = 100))
# Set up training control
train_control <- trainControl(method = "cv", number = 3)


```



```{r}
fit.lasso <- train(avg_price_per_room ~ ., 
                   data= trainData,
                   #select glmnet method
                   method= "glmnet",
                   #calculate rmse metric
                   metric= "RMSE",
                   #add tuning parameters
                   tuneGrid= grid)
```


```{r}
fit.lasso$finalModel$xNames
```

```{r}
predictions_lasso <- fit.lasso %>% predict(testData)
```
```{r}
 Lasso_R2 = R2(predictions_lasso, testData)
```








































